{
  "id": "snapshot_1767166982931_8wq874hiw",
  "approvalId": "approval_1767166919288_tzbydgcc3",
  "approvalTitle": "Docker配置重构 - 设计文档",
  "version": 2,
  "timestamp": "2025-12-31T07:43:02.931Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本设计旨在消除 `preview_base_url` 配置的重复定义，通过修改 `DockerConfig` 数据类，移除其默认值，强制通过构造函数传入配置。现有的工厂模式已经正确地从 `Settings` 读取配置，因此只需最小化的修改即可实现 DRY 原则。\n\n## Steering Document Alignment\n\n本项目暂无 steering 文档，设计遵循通用最佳实践。\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`app.core.config.Settings`**: 全局配置类，已经是 `DOCKER_PREVIEW_BASE_URL` 的权威来源\n- **`app.services.sandbox_providers.factory.create_docker_config()`**: 工厂函数，已正确地从 `Settings` 读取所有 Docker 配置并创建 `DockerConfig` 实例\n\n### Integration Points\n\n- **`app.services.sandbox_providers.types.DockerConfig`**: 需要移除 `preview_base_url` 的默认值\n- **`app.services.sandbox_providers.docker_provider.LocalDockerProvider`**: 通过 `self.config.preview_base_url` 使用配置，无需修改\n- **所有测试文件**: 需要确保在创建 `DockerConfig` 时显式传入 `preview_base_url`\n\n## Architecture\n\n### Modular Design Principles\n\n- **Single File Responsibility**: `types.py` 仅负责类型定义，不包含默认配置值\n- **Component Isolation**: 配置定义与配置使用分离，`Settings` 定义配置，`DockerConfig` 传递配置\n- **Dependency Injection**: 通过构造函数注入配置值，而非硬编码默认值\n\n### Current Flow\n\n```mermaid\ngraph TD\n    A[Settings.DOCKER_PREVIEW_BASE_URL] --> B[create_docker_config]\n    B --> C[DockerConfig instance]\n    C --> D[LocalDockerProvider]\n    D --> E[使用 self.config.preview_base_url]\n\n    style A fill:#e1f5e1\n    style C fill:#ffe6e6\n```\n\n### Target Flow\n\n```mermaid\ngraph TD\n    A[Settings.DOCKER_PREVIEW_BASE_URL] --> B[create_docker_config]\n    B --> C[DockerConfig instance - 无默认值]\n    C --> D[LocalDockerProvider]\n    D --> E[使用 self.config.preview_base_url]\n\n    style A fill:#e1f5e1\n    style C fill:#e1f5e1\n```\n\n## Components and Interfaces\n\n### Component 1: DockerConfig (types.py)\n\n- **Purpose:** 数据类，定义 Docker 沙箱的运行时配置\n- **Current State:** `preview_base_url: str = \"http://192.168.1.44\"` (有默认值)\n- **Target State:** `preview_base_url: str` (无默认值，必填参数)\n- **Dependencies:** 无\n- **Reuses:** 无\n\n### Component 2: create_docker_config (factory.py)\n\n- **Purpose:** 工厂函数，从 `Settings` 创建配置好的 `DockerConfig` 实例\n- **Current Implementation:**\n  ```python\n  def create_docker_config() -> DockerConfig:\n      return DockerConfig(\n          image=settings.DOCKER_IMAGE,\n          network=settings.DOCKER_NETWORK,\n          host=settings.DOCKER_HOST,\n          preview_base_url=settings.DOCKER_PREVIEW_BASE_URL,  # 已正确传递\n      )\n  ```\n- **Changes Required:** 无需修改 ✅\n- **Dependencies:** `Settings`, `DockerConfig`\n\n### Component 3: LocalDockerProvider (docker_provider.py)\n\n- **Purpose:** Docker 沙箱提供商实现\n- **Usage:** 通过 `self.config.preview_base_url` 访问配置 (line 515, 563)\n- **Changes Required:** 无需修改 ✅\n- **Dependencies:** `DockerConfig`\n\n## Data Models\n\n### DockerConfig (修改后)\n\n```python\n@dataclass\nclass DockerConfig:\n    image: str  # 无默认值\n    network: str  # 无默认值\n    host: str | None  # 保留 None 默认值（可选参数）\n    preview_base_url: str  # 移除默认值 \"http://192.168.1.44\"\n    user_home: str = \"/home/user\"\n    openvscode_port: int = 8765\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **直接实例化 DockerConfig 而未提供 preview_base_url**\n   - **Handling:** Python 类型系统会在运行时抛出 `TypeError`\n   - **User Impact:** 开发者会立即收到明确的错误信息，提示缺少必需参数\n   - **Prevention:** 代码文档应明确说明应使用 `create_docker_config()` 工厂函数\n\n2. **测试代码中创建 DockerConfig**\n   - **Handling:** 需要显式传入 `preview_base_url` 参数\n   - **User Impact:** 测试代码需要更新以提供必需参数\n   - **Prevention:** 在 conftest.py 中提供 fixture 统一创建配置\n\n## Testing Strategy\n\n### Unit Testing\n\n- **DockerConfig 实例化:** 测试缺少 `preview_base_url` 时抛出异常\n- **create_docker_config:** 验证从 Settings 正确读取所有配置\n- **LocalDockerProvider:** 验证使用传入的配置值\n\n### Integration Testing\n\n- **端到端流程:** 验证从 `.env` → Settings → create_docker_config → DockerConfig → Provider 的完整流程\n- **预览链接生成:** 验证 `get_preview_links()` 使用正确的 `preview_base_url`\n\n### Test Files to Update\n\n- `tests/conftest.py` - 更新 fixture 以显式传入 `preview_base_url`\n- `tests/unit/test_docker_provider.py` - 更新测试以使用工厂函数或显式传入配置\n- `tests/integration/test_sandbox.py` - 验证配置流程\n\n## Implementation Changes Summary\n\n### Files to Modify\n\n1. **`backend/app/services/sandbox_providers/types.py`**\n   - 移除 `DockerConfig.preview_base_url` 的默认值\n   - 添加文档注释说明该参数为必需\n\n2. **`backend/tests/conftest.py`** (如果存在)\n   - 更新 `docker_config` fixture 以显式传入 `preview_base_url`\n\n### Files to Verify (No Changes Expected)\n\n1. **`backend/app/core/config.py`** - 无需修改，已有 `DOCKER_PREVIEW_BASE_URL`\n2. **`backend/app/services/sandbox_providers/factory.py`** - 无需修改，已正确传递配置\n3. **`backend/app/services/sandbox_providers/docker_provider.py`** - 无需修改\n\n## Backward Compatibility\n\n### Breaking Changes\n\n- **DockerConfig 直接实例化:** 现在必须显式提供 `preview_base_url`\n- **Impact:** 任何直接实例化 `DockerConfig()` 而不传参数的代码会失败\n\n### Mitigation\n\n- 项目中应使用 `create_docker_config()` 工厂函数（已在 factory.py:9-15 实现）\n- 测试代码需要显式传入参数\n- 这是有意的破坏性变更，旨在强制使用单一配置源\n",
  "fileStats": {
    "size": 6005,
    "lines": 168,
    "lastModified": "2025-12-31T07:41:57.026Z"
  },
  "comments": []
}